<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Commit {{ sha }}</title>
  {% set use_local_assets = handler.settings.get("use_local_assets") %}
  {% if use_local_assets %}
  <link rel="stylesheet" href="{{ static_url('vendor/bootstrap-5.3.7.min.css') }}">
  <script src="{{ static_url('vendor/bootstrap-5.3.7.bundle.min.js') }}"></script>
  <link rel="stylesheet" href="{{ static_url('vendor/diff2html-3.4.52.min.css') }}">
  <script src="{{ static_url('vendor/diff2html-ui-3.4.52.min.js') }}"></script>
  {% else %}
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
    crossorigin="anonymous"
  >
  <link rel="stylesheet" href="{{ static_url('vendor/bootstrap-5.3.7.min.css') }}">
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"
  ></script>
  <script>
    if (typeof bootstrap === "undefined") {
      document.write('<script src="{{ static_url("vendor/bootstrap-5.3.7.bundle.min.js") }}"><\\/script>');
    }
  </script>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/diff2html@3.4.52/bundles/css/diff2html.min.css"
    integrity="sha384-iBvSlI3tNrrSIy7s6mvLg+5B2Z/QXbR4L0Pzg1nRf8zkXrz5JF316MLm2igMIpi2"
    crossorigin="anonymous"
  >
  <link rel="stylesheet" href="{{ static_url('vendor/diff2html-3.4.52.min.css') }}">
  <script
    src="https://cdn.jsdelivr.net/npm/diff2html@3.4.52/bundles/js/diff2html-ui.min.js"
    integrity="sha384-W/jmQerulguVR1xkBEsaMJZLFxGoL5QUZlM/yHDf+T17CV9JzeaTltKp8BwY4Bzt"
    crossorigin="anonymous"
  ></script>
  <script>
    if (typeof Diff2HtmlUI === "undefined") {
      document.write('<script src="{{ static_url("vendor/diff2html-ui-3.4.52.min.js") }}"><\\/script>');
    }
  </script>
  {% end %}
</head>
<body>
  <main class="container py-4">

    <header class="mb-3">
      <h1 class="h4">git show {{ sha }}</h1>

      {% if parents or children %}
        <nav class="small mb-2">
          {% if parents %}
            <strong>Parents:</strong><br>
            {% for p in parents %}
              <a href="/commit/{{ p }}">{{ p[:7] }}</a><br>
            {% end %}
          {% end %}
          {% if children %}
            <strong>Children:</strong><br>
            {% for c in children %}
              <a href="/commit/{{ c }}">{{ c[:7] }}</a><br>
            {% end %}
          {% end %}
        </nav>
      {% end %}

      {% if describe_name %}
        <p class="text-muted"><em> {{describe_name}} </em></p>
      {% end %}

      {% if follows or precedes %}
        <nav class="small mb-2">
          {% if follows and follows.count > 0 %}
            <strong>Follows:</strong>
            {{ follows.base_tag }}
            (<a href="/commit/{{ follows.tag_sha }}">{{ follows.tag_sha[:7] }}</a>)<br>
          {% end %}
          {% if precedes %}
            <strong>Precedes:</strong>
            {{ precedes.base_tag }}
            (<a href="/commit/{{ precedes.tag_sha }}">{{ precedes.tag_sha[:7] }}</a>)
          {% end %}
        </nav>
      {% end %}
      
      <div class="d-flex flex-wrap gap-2">
        <a id="back-link" class="btn btn-outline-secondary" href="/#sha-{{ sha[:7] }}">← Back to index</a>
        <a class="btn btn-outline-secondary" href="/issues">Browse issues</a>
      </div>
    </header>

    <section class="mb-4" aria-labelledby="commit-form-title">
      <h2 id="commit-form-title" class="h5 mb-3">Edit Metadata</h2>
      <form action="/commit/{{ commit['sha'] }}/update" method="post">
        <div class="mb-3">
          <label for="issue" class="form-label">Issue</label>
          <input type="text" class="form-control" name="issue" id="issue" value="{{ issue_value }}">
          {% if issue_suggestion %}
          <div id="issue-suggestion" class="form-text mt-2 d-flex flex-wrap gap-2 align-items-center">
            {% if not issue_prefilled %}
            <button
              type="button"
              id="issue-suggestion-apply"
              class="btn btn-link btn-sm p-0"
              data-issue="{{ issue_suggestion }}"
            >
              Use
            </button>
            {% end %}
            <a class="link-underline link-underline-opacity-0" href="/issue/{{ issue_suggestion }}">{{ issue_suggestion }}</a>
          </div>
          {% end %}
        </div>
        <div class="mb-3">
          <label for="release" class="form-label">Release</label>
          <input type="text" class="form-control" name="release" id="release" value="{{ release_value }}">
          {% if release_suggestion %}
          <div id="release-suggestion" class="form-text mt-2 d-flex flex-wrap gap-2 align-items-center">
            <button
              type="button"
              id="release-suggestion-apply"
              class="btn btn-link btn-sm p-0"
              data-release="{{ release_suggestion }}"
              {% if release_suggestion_source %}
              data-source="{{ release_suggestion_source }}"
              {% end %}
            >
              Use
            </button>
            {% if release_suggestion_label %}
            <span class="badge text-bg-secondary release-suggestion-source">{{ release_suggestion_label }}</span>
            {% end %}
            <span class="release-suggestion-value">{{ release_suggestion }}</span>
          </div>
          {% end %}
        </div>
        <button type="submit" class="btn btn-primary">Update</button>
      </form>
      {% if issue_suggestion and not issue_prefilled %}
      <script>
        (function attachIssueSuggestionButton() {
          const button = document.getElementById("issue-suggestion-apply");
          if (!button) return;
          button.addEventListener("click", () => {
            const issueField = document.getElementById("issue");
            if (!issueField) {
              return;
            }
            const value = button.dataset.issue || "{{ issue_suggestion }}";
            issueField.value = value;
            issueField.focus();
          });
        })();
      </script>
      {% end %}
      {% if release_suggestion %}
      <script>
        (function attachReleaseSuggestionButton() {
          const button = document.getElementById("release-suggestion-apply");
          if (!button) return;
          button.addEventListener("click", () => {
            const releaseField = document.getElementById("release");
            if (!releaseField) {
              return;
            }
            const value = button.dataset.release || "{{ release_suggestion }}";
            releaseField.value = value;
            releaseField.focus();
          });
        })();
      </script>
      {% end %}
    </section>

    <section class="mb-4" aria-labelledby="commit-header-title">
      <h2 id="commit-header-title" class="visually-hidden">Commit Header</h2>
      <pre class="bg-light p-3 border rounded">{{ output_header }}</pre>
    </section>

    {% if linked_issues %}
    <div>
      Related Issues:
      {% for slug in linked_issues %}
      <a href="/issue/{{ slug }}">{{ slug }}</a>
      {% end %}
    </div>
    {% end %}

    <section class="mb-4" aria-labelledby="commit-diff-title">
      <h2 id="commit-diff-title" class="visually-hidden">Diff</h2>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-bold">Diff</span>
        <button id="copy-diff-btn" class="btn btn-sm btn-outline-secondary" type="button">
          Copy
        </button>
      </div>

      <div id="diff" class="border rounded">
        <pre class="bg-light p-3 m-0">{{ output_diff }}</pre>
      </div>

      <script>
        const container = document.getElementById("diff");
        const rawText = container.textContent;

        // Pretty diff
        const ui = new Diff2HtmlUI(container, rawText, {
          drawFileList: true,
          outputFormat: "line-by-line",
          matching: "lines",
        });
        ui.draw();

        // Clipboard button behavior
        const copyBtn = document.getElementById("copy-diff-btn");

        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(rawText);

            const original = copyBtn.textContent;
            copyBtn.innerHTML = "&#10003; Copied!"; // ✓ Copied!

            setTimeout(() => {
              copyBtn.textContent = original;
            }, 2000);
          } catch (err) {
            console.error("Copy failed", err);
            copyBtn.textContent = "Error";
            setTimeout(() => {
              copyBtn.textContent = "Copy";
            }, 2000);
          }
        });
      </script>
    </section>

    <footer class="mt-4">
      <a id="back-link" class="btn btn-outline-secondary" href="/#sha-{{ sha[:7] }}">← Back to index</a>
    </footer>

  </main>
</body>
</html>
