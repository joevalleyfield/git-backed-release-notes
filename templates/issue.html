<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Issue: {{ slug }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

  <!-- EasyMDE -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

  <!-- marked + DOMPurify for preview -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.3/dist/purify.min.js"></script>
</head>
<body>
  <main class="container py-4">
    <header class="mb-4">
      <h1 class="h4">Issue: {{ slug }}</h1>
      <p><strong>Status:</strong> {{ status }}</p>
    </header>

    <form action="/issue/{{ slug }}/update" method="post" class="mb-4">
      <ul class="nav nav-tabs mb-2" id="editorTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">Raw</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">Preview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="wysiwyg-tab" data-bs-toggle="tab" data-bs-target="#wysiwyg" type="button" role="tab">WYSIWYG</button>
        </li>
      </ul>

      <div class="tab-content border rounded p-3" id="editorTabsContent">
        <div class="tab-pane fade show active" id="edit" role="tabpanel">
          <textarea name="markdown" id="markdown" class="form-control" rows="20" style="font-family: monospace;">{{ content }}</textarea>
        </div>
        <div class="tab-pane fade" id="preview" role="tabpanel">
          <div id="preview-content" class="markdown-body"></div>
        </div>
        <div class="tab-pane fade" id="wysiwyg" role="tabpanel">
          <textarea id="wysiwyg-textarea">{{ content }}</textarea>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>

    {% if linked_commits %}
      <section>
        <h2 class="h5">Linked Commits</h2>
        <ul class="list-group">
          {% for sha in linked_commits %}
            <li class="list-group-item"><a href="/commit/{{ sha }}">{{ sha }}</a></li>
          {% end %}
        </ul>
      </section>
    {% end %}
  </main>

  <script>
    const raw = document.getElementById('markdown');
    const wysiwygTextarea = document.getElementById('wysiwyg-textarea');
    const preview = document.getElementById('preview-content');

    // Setup EasyMDE for WYSIWIG
    const easyMDE = new EasyMDE({
      element: wysiwygTextarea,
      autoDownloadFontAwesome: false,
      status: false,
      toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'preview', 'guide']
    });

    // Sync from WYSIWYG to raw greedily 
    easyMDE.codemirror.on('change', () => {
      raw.value = easyMDE.value();
    });

    // Sync preview when switching tabs
    document.getElementById('preview-tab').addEventListener('shown.bs.tab', () => {
      preview.innerHTML = DOMPurify.sanitize(marked.parse(raw.value));
    });

    // Sync from raw when switching to WYSIWYG
    document.getElementById('wysiwyg-tab').addEventListener('shown.bs.tab', () => {
      easyMDE.value(raw.value);
    });
  </script>
</body>
</html>
